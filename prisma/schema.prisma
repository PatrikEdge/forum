  generator client {
    provider = "prisma-client-js"
  }

  datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
  }

  model User {
    id            String         @id @default(cuid())
    username      String         @unique
    email         String         @unique
    password      String
    avatarUrl     String?
    role          Role           @default(USER)
    joinedAt      DateTime       @default(now())
    chatMessages  ChatMessage[]
    ChatReactions ChatReaction[]
    dmSent        DMMessage[]    @relation("DMFrom")
    dmReceived    DMMessage[]    @relation("DMTo")
    likes         Like[]
    notifications Notification[]
    posts         Post[]
    threads       Thread[]

    dmConvUser1 DMConversation[] @relation("DMUser1")
    dmConvUser2 DMConversation[] @relation("DMUser2")

    @@index([email])
    @@index([username])
  }

  model Category {
    id      String   @id @default(cuid())
    name    String   @unique
    threads Thread[]

    @@index([name])
  }

  model Thread {
    id         String   @id @default(cuid())
    title      String
    excerpt    String
    authorId   String
    categoryId String
    lastActive DateTime @default(now())
    isPinned   Boolean  @default(false)
    createdAt  DateTime @default(now())
    isLocked   Boolean  @default(false)
    posts      Post[]
    author     User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
    category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

    @@index([authorId])
    @@index([categoryId])
    @@index([createdAt])
    @@index([lastActive])
  }

  model Post {
    id        String   @id @default(cuid())
    text      String
    createdAt DateTime @default(now())
    authorId  String
    threadId  String
    likes     Like[]
    author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
    thread    Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)

    @@index([authorId])
    @@index([threadId])
    @@index([createdAt])
  }

  model Like {
    id        String   @id @default(cuid())
    userId    String
    postId    String
    createdAt DateTime @default(now())
    post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([userId, postId])
    @@index([userId])
    @@index([postId])
  }

  model ChatMessage {
    id        String         @id @default(cuid())
    text      String
    createdAt DateTime       @default(now())
    authorId  String
    edited    Boolean        @default(false)
    author    User           @relation(fields: [authorId], references: [id], onDelete: Cascade)
    reactions ChatReaction[]

    @@index([authorId])
    @@index([createdAt])
  }

  model ChatReaction {
    id        String      @id @default(cuid())
    messageId String
    userId    String
    emoji     String
    createdAt DateTime    @default(now())
    message   ChatMessage @relation(fields: [messageId], references: [id])
    user      User        @relation(fields: [userId], references: [id])

    @@unique([messageId, userId, emoji], name: "userReactionUnique")
  }

  model DMMessage {
    id        String   @id @default(cuid())
    text      String?
    createdAt DateTime @default(now())
    editedAt  DateTime?
    revoked   Boolean  @default(false)
    readAt    DateTime?
    editCount Int      @default(0)
    fromId    String
    toId      String
    conversationId String?
    from      User     @relation("DMFrom", fields: [fromId], references: [id], onDelete: Cascade)
    to        User     @relation("DMTo", fields: [toId], references: [id], onDelete: Cascade)
    conversation DMConversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

    @@index([conversationId])
    @@index([createdAt])
  }


  model DMConversation {
    id         String      @id @default(cuid())
    user1Id    String
    user2Id    String
    lastMessageAt DateTime @default(now())
    messages   DMMessage[]
    user1      User @relation("DMUser1", fields: [user1Id], references: [id], onDelete: Cascade)
    user2      User @relation("DMUser2", fields: [user2Id], references: [id], onDelete: Cascade)
    
    @@unique([user1Id, user2Id])
    @@index([lastMessageAt])
  }

  model Notification {
    id        String   @id @default(cuid())
    type      String   @default("INFO")
    title     String
    message   String
    createdAt DateTime @default(now())
    userId    String
    isRead    Boolean  @default(false)
    user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@index([userId])
    @@index([isRead])
    @@index([createdAt])
  }

  enum Role {
    USER
    MODERATOR
    ADMIN
  }
